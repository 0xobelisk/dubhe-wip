# âš ï¸ å·²è¢« unified-release.yml æ›¿ä»£ï¼Œé˜²æ­¢å†²çªå·²ç¦ç”¨
name: Sui Rust Indexer - è·¨å¹³å°å‘å¸ƒ (DISABLED)

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘ï¼Œä¸å†è‡ªåŠ¨è¿è¡Œ

env:
  CARGO_TERM_COLOR: always

jobs:
  update-version:
    name: æ›´æ–°ç‰ˆæœ¬å·
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: æ›´æ–° Cargo.toml ç‰ˆæœ¬
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          # ç§»é™¤ v å‰ç¼€
          VERSION=${VERSION#v}

          # ä½¿ç”¨ sed æ›´æ–° Cargo.toml ä¸­çš„ç‰ˆæœ¬
          sed -i "s/^version = .*/version = \"${VERSION}\"/" packages/sui-rust-indexer/Cargo.toml

          echo "âœ… å·²æ›´æ–°ç‰ˆæœ¬åˆ°: ${VERSION}"
          cat packages/sui-rust-indexer/Cargo.toml | grep -E "^(name|version)"

      - name: é…ç½® Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: æäº¤ç‰ˆæœ¬æ›´æ–°
        run: |
          git add packages/sui-rust-indexer/Cargo.toml
          git commit -m "chore(sui-rust-indexer): bump version to ${{ steps.get_version.outputs.VERSION }}"
          git push origin HEAD:main
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}

  build:
    name: æ„å»º ${{ matrix.platform }}
    needs: update-version
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - platform: linux-x64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary_ext: ''
          - platform: linux-arm64
            os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            binary_ext: ''

          # macOS
          - platform: macos-x64
            os: macos-latest
            target: x86_64-apple-darwin
            binary_ext: ''
          - platform: macos-arm64
            os: macos-latest
            target: aarch64-apple-darwin
            binary_ext: ''

          # Windows
          - platform: windows-x64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            binary_ext: .exe

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: main # è·å–æ›´æ–°åçš„ä¸»åˆ†æ”¯ä»£ç 

      - name: è®¾ç½® Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: é…ç½® Rust ç¼“å­˜
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/sui-rust-indexer

      - name: å®‰è£… Linux äº¤å‰ç¼–è¯‘ä¾èµ–
        if: matrix.os == 'ubuntu-latest' && matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: é…ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒå˜é‡
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          echo "CXX_aarch64_unknown_linux_gnu=aarch64-linux-gnu-g++" >> $GITHUB_ENV
          echo "CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

      - name: ç¼–è¯‘é¡¹ç›®
        working-directory: packages/sui-rust-indexer
        run: |
          cargo build --release --target ${{ matrix.target }}

      - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
        working-directory: packages/sui-rust-indexer
        shell: bash
        run: |
          mkdir -p dist
          binary_name="dubhe-indexer${{ matrix.binary_ext }}"
          archive_name="dubhe-sui-indexer-${{ github.ref_name || 'latest' }}-${{ matrix.platform }}"

          # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
          cp target/${{ matrix.target }}/release/${binary_name} dist/

          # ç»Ÿä¸€åˆ›å»º tar.gz å‹ç¼©åŒ…
          cd dist
          tar -czf ${archive_name}.tar.gz ${binary_name}

          # è¾“å‡ºä¿¡æ¯ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "ARCHIVE_NAME=${archive_name}" >> $GITHUB_ENV
          echo "ARCHIVE_PATH=packages/sui-rust-indexer/dist/${archive_name}.tar.gz" >> $GITHUB_ENV

      - name: è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
        shell: bash
        run: |
          hash=$(shasum -a 256 "${{ env.ARCHIVE_PATH }}" | cut -d' ' -f1)
          echo "ARCHIVE_HASH=$hash" >> $GITHUB_ENV
          echo "Archive hash: $hash"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: dubhe-sui-indexer-${{ github.ref_name || 'latest' }}-${{ matrix.platform }}
          path: ${{ env.ARCHIVE_PATH }}
          retention-days: 30

      - name: æ˜¾ç¤ºæ„å»ºä¿¡æ¯
        shell: bash
        run: |
          echo "âœ… æ„å»ºå®Œæˆ:"
          echo "  å¹³å°: ${{ matrix.platform }}"
          echo "  ç›®æ ‡: ${{ matrix.target }}"
          echo "  æ–‡ä»¶: ${{ env.ARCHIVE_PATH }}"
          echo "  å“ˆå¸Œ: ${{ env.ARCHIVE_HASH }}"
          ls -la "${{ env.ARCHIVE_PATH }}"

  create-release:
    name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p ./release
          find ./artifacts -name "*.tar.gz" | while read file; do
            cp "$file" ./release/
          done
          ls -la ./release

      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
        run: |
          cat > release_notes.md << 'EOF'
          ## ğŸš€ Dubhe Sui Rust Indexer å‘å¸ƒç‰ˆæœ¬

          ### ğŸ“¦ æ”¯æŒçš„å¹³å°

          - **Linux**
            - x86_64 (Intel/AMD 64ä½)
            - ARM64 (Apple Silicon, AWS Graviton ç­‰)

          - **macOS** 
            - x86_64 (Intel Mac)
            - ARM64 (Apple Silicon M1/M2/M3)

          - **Windows**
            - x86_64 (64ä½ Windows)

          ### ğŸ“¥ ä¸‹è½½è¯´æ˜

          1. æ ¹æ®ä½ çš„ç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„æ–‡ä»¶ä¸‹è½½
          2. è§£å‹ç¼©æ–‡ä»¶
          3. å°†å¯æ‰§è¡Œæ–‡ä»¶æ”¾åˆ° PATH ç¯å¢ƒå˜é‡ä¸­çš„ç›®å½•
          4. è¿è¡Œ `dubhe-indexer --help` æŸ¥çœ‹ä½¿ç”¨è¯´æ˜

          ### ğŸ”— ä½¿ç”¨ç¤ºä¾‹

          ```bash
          # æŸ¥çœ‹å¸®åŠ©
          ./dubhe-indexer --help

          # è¿è¡Œç´¢å¼•å™¨ (testnet)
          ./dubhe-indexer --config dubhe.config.json --worker-pool-number 3 --store-url https://checkpoints.testnet.sui.io --start-checkpoint 1000

          # è¿è¡Œç´¢å¼•å™¨ (localnet)
          ./dubhe-indexer --config dubhe.config.json --worker-pool-number 3 --store-url ./chk --start-checkpoint 1
          ```

          ### ğŸ“‹ æ–‡ä»¶æ¸…å•

          EOF

          # æ·»åŠ æ–‡ä»¶åˆ—è¡¨
          for file in ./release/*; do
            filename=$(basename "$file")
            size=$(ls -lh "$file" | awk '{print $5}')
            echo "- \`$filename\` ($size)" >> release_notes.md
          done

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: ./release/*
          body_path: release_notes.md
          generate_release_notes: true
          tag_name: ${{ github.ref_name }}
          name: 'Dubhe Sui Indexer ${{ github.ref_name }}'
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}

  test-binaries:
    name: æµ‹è¯•äºŒè¿›åˆ¶æ–‡ä»¶
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
            binary_ext: ''
          - os: macos-latest
            platform: macos-arm64
            binary_ext: ''
          - os: windows-latest
            platform: windows-x64
            binary_ext: '.exe'

    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: dubhe-sui-indexer-${{ github.ref_name || 'latest' }}-${{ matrix.platform }}
          path: ./test-binary

      - name: æµ‹è¯•äºŒè¿›åˆ¶æ–‡ä»¶
        shell: bash
        run: |
          cd test-binary

          echo "ğŸ“ test-binary ç›®å½•å†…å®¹:"
          ls -la

          echo "ğŸ“¦ è§£å‹ç¼© tar.gz æ–‡ä»¶..."
          tar -xzf *.tar.gz

          echo "ğŸ“ è§£å‹åçš„æ–‡ä»¶:"
          ls -la

          # è®¾ç½®äºŒè¿›åˆ¶æ–‡ä»¶å
          binary_name="dubhe-indexer${{ matrix.binary_ext }}"

          if [[ -f "$binary_name" ]]; then
            echo "âœ… æ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶: $binary_name"
            
            # Unixç³»ç»Ÿéœ€è¦è®¾ç½®æ‰§è¡Œæƒé™
            if [[ "${{ matrix.os }}" != "windows-latest" ]]; then
              chmod +x "$binary_name"
            fi
            
            echo "ğŸ§ª æµ‹è¯•äºŒè¿›åˆ¶æ–‡ä»¶..."
            ./"$binary_name" --help
          else
            echo "âŒ æœªæ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶: $binary_name"
            exit 1
          fi
